# Dashboard basique pour RTE Tempo (sans mushroom-cards)
# Fonctionne avec les cartes natives Home Assistant

title: RTE Tempo
views:
  # ============================================
  # ONGLET 1 - TEMPO
  # ============================================
  - title: Tempo
    path: tempo
    icon: mdi:lightning-bolt
    cards:
      # Couleur du jour et demain
      - type: entities
        title: "ğŸ¨ Couleurs Tempo"
        entities:
          - entity: sensor.rte_tempo_couleur_actuelle
            name: "Aujourd'hui"
            icon: mdi:calendar-today
          - entity: sensor.rte_tempo_prochaine_couleur
            name: "Demain"
            icon: mdi:calendar-arrow-right

      # Heures Pleines / Creuses
      - type: entities
        title: "â° Tarification"
        entities:
          - entity: binary_sensor.rte_tempo_heures_creuses
            name: "Heures Creuses"
            icon: mdi:clock-outline

      # Compteurs de jours restants
      - type: glance
        title: "ğŸ“Š Jours restants dans le cycle"
        entities:
          - entity: sensor.rte_tempo_cycle_jours_restants_rouge
            name: "Rouge"
            icon: mdi:circle
          - entity: sensor.rte_tempo_cycle_jours_restants_blanc
            name: "Blanc"
            icon: mdi:circle-outline
          - entity: sensor.rte_tempo_cycle_jours_restants_bleu
            name: "Bleu"
            icon: mdi:circle

      # PrÃ©visions J+2 Ã  J+7 (nÃ©cessite Open DPE activÃ©)
      - type: markdown
        title: "ğŸ“… PrÃ©visions (Open DPE)"
        content: |
          | Jour | Couleur | ProbabilitÃ© |
          |------|---------|-------------|
          {% set day_names = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'] %}
          {% for i in range(2, 8) %}
          {% set sensor = 'sensor.rte_tempo_forecast_opendpe_j' ~ i %}
          {% set couleur = states(sensor) %}
          {% set proba = state_attr(sensor, 'probability') %}
          {% set indicator = state_attr(sensor, 'indicator') %}
          {% set date = now() + timedelta(days=i) %}
          {% set jour = day_names[date.weekday()] %}
          {% set emoji = 'ğŸ”´' if couleur == 'Rouge' else ('âšª' if couleur == 'Blanc' else 'ğŸ”µ') %}
          {% set info = 'ğŸ—“ï¸ Dimanche' if indicator == 'D' else ('ğŸ‰ FÃ©riÃ©' if indicator == 'F' else ((proba * 100) | round ~ '%' if proba else '-')) %}
          | {{ jour }} | {{ emoji }} {{ couleur }} | {{ info }} |
          {% endfor %}

  # ============================================
  # ONGLET 2 - PRÃ‰CISION DES PRÃ‰VISIONS
  # ============================================
  - title: PrÃ©cision
    path: precision
    icon: mdi:chart-line
    cards:
      # PrÃ©cision globale
      - type: glance
        title: "ğŸ“ˆ PrÃ©cision par horizon"
        entities:
          - entity: sensor.rte_tempo_forecast_accuracy
            name: "30 jours (J-2)"
            icon: mdi:percent

      # Tableau PASSÃ‰ - Historique avec comparaison
      - type: markdown
        title: "ğŸ“‹ Historique (PassÃ©)"
        content: |
          {% set matrix = state_attr('sensor.rte_tempo_forecast_accuracy', 'past_matrix') %}
          {% macro color_emoji(c) %}{% if c == 'rouge' %}ğŸ”´{% elif c == 'blanc' %}âšª{% elif c == 'bleu' %}ğŸ”µ{% else %}--{% endif %}{% endmacro %}
          {% macro cell(jdata) %}{% if jdata and jdata.color %}{{ color_emoji(jdata.color) }}{% if jdata.result == 'âœ“' %}âœ“{% elif jdata.result == 'âœ—' %}âœ—{% endif %}{% else %}--{% endif %}{% endmacro %}
          | Date  |  J-7  |  J-6  |  J-5  |  J-4  |  J-3  |  J-2  | RÃ©el  |
          |:-----:|:-----:|:-----:|:-----:|:-----:|:-----:|:-----:|:-----:|
          {% if matrix %}{% for row in matrix[:15] %}| {{ row.date[5:] }} | {{ cell(row.j7) }} | {{ cell(row.j6) }} | {{ cell(row.j5) }} | {{ cell(row.j4) }} | {{ cell(row.j3) }} | {{ cell(row.j2) }} | {{ color_emoji(row.actual) }} |
          {% endfor %}{% endif %}

      # Tableau FUTUR - PrÃ©visions actuelles
      - type: markdown
        title: "ğŸ”® PrÃ©visions Futures"
        content: |
          {% set matrix = state_attr('sensor.rte_tempo_forecast_accuracy', 'future_matrix') %}
          {% macro color_emoji(c) %}{% if c == 'rouge' %}ğŸ”´{% elif c == 'blanc' %}âšª{% elif c == 'bleu' %}ğŸ”µ{% else %}--{% endif %}{% endmacro %}
          {% macro cell(jdata) %}{% if jdata and jdata.color %}{{ color_emoji(jdata.color) }}{% else %}--{% endif %}{% endmacro %}
          | Date  |  J-7  |  J-6  |  J-5  |  J-4  |  J-3  |  J-2  |
          |:-----:|:-----:|:-----:|:-----:|:-----:|:-----:|:-----:|
          {% if matrix %}{% for row in matrix %}| {{ row.date[5:] }} | {{ cell(row.j7) }} | {{ cell(row.j6) }} | {{ cell(row.j5) }} | {{ cell(row.j4) }} | {{ cell(row.j3) }} | {{ cell(row.j2) }} |
          {% endfor %}{% endif %}

      # LÃ©gende
      - type: markdown
        content: |
          **LÃ©gende:** ğŸ”´ Rouge Â· âšª Blanc Â· ğŸ”µ Bleu Â· -- N/A | âœ“ OK Â· âœ— Erreur
